<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Cross-Site Tracker â€” Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:opsz,wght@6..96,500;6..96,700&family=IBM+Plex+Sans+Condensed:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
    <link rel="stylesheet" href="/assets/dashboard.css">
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
</head>

<body>
    <div class="grain"></div>
    <main class="shell">
        <header class="masthead">
            <div class="masthead__copy">
                <p class="kicker">Cross-Site Tracker</p>
                <h1>Editorial Control Room</h1>
                <p class="subtitle">Track updates across sources with sharp filters, fast edits, and a focused reading queue.</p>
            </div>
            <form class="profile-toolbar" method="post" action="/dashboard/profile/rename" id="profile-rename-form">
                <label class="profile-toolbar__label profile-toolbar__label--profile">
                    Profile
                    <select name="profile" id="profile-switch" onchange="window.onProfileSwitch(this)">
                        {{range .Profiles}}
                        <option value="{{.Key}}" {{if eq .Key $.ActiveProfile.Key}}selected{{end}}>{{.Name}}</option>
                        {{end}}
                    </select>
                </label>
                <input type="hidden" name="profile_name" id="profile-rename-value" value="{{.RenameValue}}">
                <button type="button" class="action-btn action-btn--accent" onclick="window.renameProfileOnce()">Rename Profile</button>
            </form>
        </header>

        <section class="control-panel">
            <form id="tracker-filters"
                  hx-get="/dashboard/trackers"
                  hx-target="#trackers-zone"
                  hx-trigger="change from:select, keyup changed delay:300ms from:input[name='q'], load, trackersChanged from:body"
                  class="filters-grid">
                <label>
                    Search
                    <input type="text" name="q" placeholder="Title">
                </label>
                <label>
                    Status
                    <select name="status">
                        {{range .Statuses}}
                        <option value="{{.}}" title="{{statusLabel .}}" {{if eq . "reading"}}selected{{end}}>{{statusLabel .}}</option>
                        {{end}}
                    </select>
                </label>
                <label>
                    Sort
                    <select name="sort">
                        {{range .Sorts}}
                        <option value="{{.}}" title="{{sortLabel .}}">{{sortLabel .}}</option>
                        {{end}}
                    </select>
                </label>
                <label>
                    Order
                    <select name="order">
                        <option value="desc">desc</option>
                        <option value="asc">asc</option>
                    </select>
                </label>
                <input type="hidden" name="profile" id="profile-filter" value="{{.ActiveProfile.Key}}">
                <input type="hidden" name="view" id="view-input" value="grid">
            </form>

            <div class="panel-actions">
                <button type="button"
                        class="action-btn"
                        onclick="document.getElementById('view-input').value='grid'; document.body.dispatchEvent(new Event('trackersChanged'))">
                    Grid
                </button>
                <button type="button"
                        class="action-btn"
                        onclick="document.getElementById('view-input').value='list'; document.body.dispatchEvent(new Event('trackersChanged'))">
                    List
                </button>
                <button type="button"
                        class="action-btn action-btn--accent"
                        hx-get="/dashboard/trackers/new"
                        hx-target="#modal-zone"
                        hx-swap="innerHTML">
                    + Add Tracker
                </button>
            </div>
        </section>

        <section id="trackers-zone" class="trackers-zone"></section>
    </main>

    <div id="modal-zone"></div>

    <script>
        window.escapeHtml = function (value) {
            return String(value || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\"/g, '&quot;')
                .replace(/'/g, '&#39;');
        };

        window.onProfileSwitch = function (select) {
            if (!select) {
                return;
            }

            var selectedProfile = (select.value || '').trim();
            if (!selectedProfile) {
                return;
            }

            var hiddenProfile = document.getElementById('profile-filter');
            if (hiddenProfile) {
                hiddenProfile.value = selectedProfile;
            }

            var renameForm = document.getElementById('profile-rename-form');
            if (renameForm) {
                renameForm.setAttribute('action', '/dashboard/profile/rename?profile=' + encodeURIComponent(selectedProfile));
            }

            if (window.history && window.history.replaceState) {
                var nextURL = '/dashboard?profile=' + encodeURIComponent(selectedProfile);
                window.history.replaceState({}, '', nextURL);
            }

            document.body.dispatchEvent(new Event('trackersChanged'));
        };

        window.renameProfileOnce = function () {
            var select = document.getElementById('profile-switch');
            var hiddenInput = document.getElementById('profile-rename-value');
            var form = document.getElementById('profile-rename-form');
            if (!select || !hiddenInput || !form) {
                return;
            }

            var currentName = select.options && select.selectedIndex >= 0
                ? select.options[select.selectedIndex].text
                : hiddenInput.value;

            var nextName = window.prompt('Rename profile', currentName || '');
            if (nextName === null) {
                return;
            }

            nextName = String(nextName).trim();
            if (!nextName) {
                return;
            }

            hiddenInput.value = nextName;

            var selectedProfile = (select.value || '').trim();
            if (selectedProfile) {
                form.setAttribute('action', '/dashboard/profile/rename?profile=' + encodeURIComponent(selectedProfile));
            }

            form.submit();
        };

        document.addEventListener('DOMContentLoaded', function () {
            var select = document.getElementById('profile-switch');
            if (select) {
                window.onProfileSwitch(select);
            }
        });

        window.renderLinkedSources = function (form) {
            if (!form) {
                return;
            }

            var hidden = form.querySelector('#linked-sources-json');
            var list = form.querySelector('#linked-sources-list');
            if (!hidden || !list) {
                return;
            }

            var items = [];
            try {
                items = JSON.parse(hidden.value || '[]');
            } catch (_) {
                items = [];
            }

            if (!Array.isArray(items) || items.length === 0) {
                list.innerHTML = '<p class="search-message">No linked sites yet.</p>';
                return;
            }

            var html = items.map(function (item, index) {
                var sourceName = window.escapeHtml(item.sourceName || ('Source #' + item.sourceId));
                var sourceUrl = window.escapeHtml(item.sourceUrl || '');
                return '' +
                    '<div class="linked-source-row">' +
                    '<span class="linked-source-name">' + sourceName + '</span>' +
                    '<a class="linked-btn" href="' + sourceUrl + '" target="_blank" rel="noopener noreferrer">Open</a>' +
                    '<button type="button" class="linked-btn linked-btn--danger" onclick="window.removeTrackerLinkedSource(' + index + ', this)">Remove</button>' +
                    '</div>';
            }).join('');

            list.innerHTML = html;
        };

        window.syncLinkedSourceSelect = function (form) {
            if (!form) {
                return;
            }

            var select = form.querySelector('#linked-source-id');
            var hidden = form.querySelector('#linked-sources-json');
            var allSourcesHidden = form.querySelector('#all-sources-json');
            if (!select || !hidden || !allSourcesHidden) {
                return;
            }

            var linkedItems = [];
            try {
                linkedItems = JSON.parse(hidden.value || '[]');
            } catch (_) {
                linkedItems = [];
            }
            if (!Array.isArray(linkedItems)) {
                linkedItems = [];
            }

            var allSources = [];
            try {
                allSources = JSON.parse(allSourcesHidden.value || '[]');
            } catch (_) {
                allSources = [];
            }
            if (!Array.isArray(allSources)) {
                allSources = [];
            }

            var linkedSourceIDs = {};
            linkedItems.forEach(function (item) {
                var sourceID = Number(item && item.sourceId);
                if (sourceID > 0) {
                    linkedSourceIDs[sourceID] = true;
                }
            });

            var previousValue = select.value;
            var optionHtml = '<option value="">Select source</option>';
            var hasPreviousValue = false;

            allSources.forEach(function (source) {
                var sourceID = Number(source && source.id);
                if (!sourceID || linkedSourceIDs[sourceID]) {
                    return;
                }

                var value = String(sourceID);
                if (value === previousValue) {
                    hasPreviousValue = true;
                }

                optionHtml += '<option value="' + value + '">' + window.escapeHtml(source.name || ('Source #' + value)) + '</option>';
            });

            select.innerHTML = optionHtml;
            select.value = hasPreviousValue ? previousValue : '';
        };

        window.removeTrackerLinkedSource = function (index, button) {
            var form = button && (button.closest('.tracker-form') || document.querySelector('#modal-zone .tracker-form'));
            if (!form) {
                return;
            }

            var hidden = form.querySelector('#linked-sources-json');
            if (!hidden) {
                return;
            }

            var items = [];
            try {
                items = JSON.parse(hidden.value || '[]');
            } catch (_) {
                items = [];
            }
            if (!Array.isArray(items)) {
                items = [];
            }

            items.splice(index, 1);
            hidden.value = JSON.stringify(items);
            window.renderLinkedSources(form);
            window.syncLinkedSourceSelect(form);
        };

        window.addTrackerLinkedSource = function (button) {
            if (!button) {
                return;
            }

            var form = button.closest('.tracker-form') || document.querySelector('#modal-zone .tracker-form');
            if (!form) {
                return;
            }

            var hidden = form.querySelector('#linked-sources-json');
            if (!hidden) {
                return;
            }

            var sourceId = parseInt(button.dataset.sourceId || '0', 10);
            var sourceUrl = button.dataset.url || '';
            if (!sourceId || !sourceUrl) {
                return;
            }

            var items = [];
            try {
                items = JSON.parse(hidden.value || '[]');
            } catch (_) {
                items = [];
            }
            if (!Array.isArray(items)) {
                items = [];
            }

            var alreadyExists = items.some(function (item) {
                return Number(item.sourceId) === sourceId && String(item.sourceUrl || '').toLowerCase() === sourceUrl.toLowerCase();
            });
            if (alreadyExists) {
                return;
            }

            items.push({
                sourceId: sourceId,
                sourceName: button.dataset.sourceName || '',
                sourceItemId: button.dataset.sourceItemId || '',
                sourceUrl: sourceUrl
            });
            hidden.value = JSON.stringify(items);

            var latestKnownField = form.querySelector('input[name="latest_known_chapter"]');
            var incomingLatestRaw = button.dataset.latestChapter;
            var incomingLatest = parseFloat(String(incomingLatestRaw || '').trim());
            var currentLatest = NaN;
            if (latestKnownField) {
                currentLatest = parseFloat(String(latestKnownField.value || '').trim());
            }

            var shouldPromoteAsPrimary = false;
            if (!Number.isNaN(incomingLatest)) {
                if (Number.isNaN(currentLatest) || incomingLatest > currentLatest) {
                    shouldPromoteAsPrimary = true;
                }
            }

            if (shouldPromoteAsPrimary) {
                var setField = function (selector, value) {
                    if (value === undefined || value === null) {
                        return;
                    }
                    var field = form.querySelector(selector);
                    if (!field) {
                        return;
                    }
                    field.value = value;
                    field.dispatchEvent(new Event('input', { bubbles: true }));
                    field.dispatchEvent(new Event('change', { bubbles: true }));
                };

                setField('select[name="source_id"]', String(sourceId));
                setField('input[name="source_url"]', sourceUrl);
                setField('input[name="source_item_id"]', button.dataset.sourceItemId || '');
                setField('input[name="latest_known_chapter"]', String(incomingLatest));

                var latestReleaseField = form.querySelector('input[name="latest_release_at"]');
                if (latestReleaseField && typeof button.dataset.latestReleaseAt !== 'undefined') {
                    latestReleaseField.value = button.dataset.latestReleaseAt || '';
                }
            }

            window.renderLinkedSources(form);
            window.syncLinkedSourceSelect(form);
        };

        window.applyTrackerSearchResult = function (button) {
            if (!button) {
                return;
            }

            var form = button.closest('.tracker-form') || document.querySelector('#modal-zone .tracker-form');
            if (!form) {
                return;
            }

            var setField = function (selector, value) {
                if (value === undefined || value === null || value === '') {
                    return;
                }
                var field = form.querySelector(selector);
                if (!field) {
                    return;
                }
                field.value = value;
                field.dispatchEvent(new Event('input', { bubbles: true }));
                field.dispatchEvent(new Event('change', { bubbles: true }));
            };

            setField('input[name="title"]', button.dataset.title || '');
            setField('input[name="source_url"]', button.dataset.url || '');
            setField('input[name="source_item_id"]', button.dataset.sourceItemId || '');
            setField('input[name="latest_known_chapter"]', button.dataset.latestChapter || '');

            var latestReleaseField = form.querySelector('input[name="latest_release_at"]');
            if (latestReleaseField) {
                latestReleaseField.value = button.dataset.latestReleaseAt || '';
            }
        };

        document.body.addEventListener('htmx:afterSwap', function (event) {
            if (!event || !event.target || event.target.id !== 'modal-zone') {
                return;
            }
            var form = event.target.querySelector('.tracker-form');
            if (form) {
                window.renderLinkedSources(form);
                window.syncLinkedSourceSelect(form);
            }
        });
    </script>
</body>

</html>
