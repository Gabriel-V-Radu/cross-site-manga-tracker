<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Cross-Site Tracker â€” Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:opsz,wght@6..96,500;6..96,700&family=IBM+Plex+Sans+Condensed:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
    <link rel="stylesheet" href="/assets/dashboard.css">
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
</head>

<body>
    <div class="grain"></div>
    <main class="shell">
        <header class="masthead">
            <div class="masthead__copy">
                <p class="kicker">Cross-Site Tracker</p>
                <h1>Editorial Control Room</h1>
                <p class="subtitle">Track updates across sources with sharp filters, fast edits, and a focused reading queue.</p>
            </div>
            <div class="profile-toolbar" id="profile-rename-form">
                <label class="profile-toolbar__label profile-toolbar__label--profile">
                    Active Profile
                    <input type="text" value="{{.ActiveProfile.Name}}" readonly>
                </label>
                <button type="button"
                        class="action-btn action-btn--accent"
                        hx-get="/dashboard/profile/menu"
                        hx-target="#modal-zone"
                        hx-swap="innerHTML">Menu</button>
            </div>
        </header>

        <section class="control-panel">
            <form id="tracker-filters"
                  hx-get="/dashboard/trackers"
                  hx-target="#trackers-zone"
                hx-trigger="change from:select, change from:input[name='tags'], keyup changed delay:300ms from:input[name='q'], load, trackersChanged from:body"
                  class="filters-grid">
                <label>
                    Search
                    <input type="text" name="q" placeholder="Title">
                </label>
                <label>
                    Status
                    <select name="status">
                        {{range .Statuses}}
                        <option value="{{.}}" title="{{statusLabel .}}" {{if eq . "reading"}}selected{{end}}>{{statusLabel .}}</option>
                        {{end}}
                    </select>
                </label>
                <label>
                    Sort
                    <select name="sort">
                        {{range .Sorts}}
                        <option value="{{.}}" title="{{sortLabel .}}">{{sortLabel .}}</option>
                        {{end}}
                    </select>
                </label>
                <label>
                    Order
                    <select name="order">
                        <option value="desc">desc</option>
                        <option value="asc">asc</option>
                    </select>
                </label>
                <label class="filters-grid__tags-row">
                    Tags
                    <details id="filter-tags-dropdown" class="filter-multi-select">
                        <summary id="filter-tags-summary">0</summary>
                        <div class="filter-multi-select__menu">
                            {{if gt (len .ProfileTags) 0}}
                            {{range .ProfileTags}}
                            <label class="filter-multi-select__option">
                                <input type="checkbox" name="tags" value="{{.Name}}">
                                <span>{{.Name}}</span>
                            </label>
                            {{end}}
                            {{else}}
                            <p class="filter-multi-select__empty">No tags created yet.</p>
                            {{end}}
                        </div>
                    </details>
                </label>
                <input type="hidden" name="profile" id="profile-filter" value="{{.ActiveProfile.Key}}">
                <input type="hidden" name="view" id="view-input" value="grid">
            </form>

            <div class="panel-actions">
                <button type="button"
                        class="action-btn"
                        onclick="document.getElementById('view-input').value='grid'; document.body.dispatchEvent(new Event('trackersChanged'))">
                    Grid
                </button>
                <button type="button"
                        class="action-btn"
                        onclick="document.getElementById('view-input').value='list'; document.body.dispatchEvent(new Event('trackersChanged'))">
                    List
                </button>
                <button type="button"
                        class="action-btn action-btn--accent"
                        hx-get="/dashboard/trackers/new"
                        hx-target="#modal-zone"
                        hx-swap="innerHTML">
                    + Add Tracker
                </button>
            </div>
        </section>

        <section id="trackers-zone" class="trackers-zone"></section>
    </main>

    <div id="modal-zone"></div>

    <script>
        window.escapeHtml = function (value) {
            return String(value || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\"/g, '&quot;')
                .replace(/'/g, '&#39;');
        };

        window.onProfileSwitch = function (select) {
            if (!select) {
                return;
            }

            var selectedProfile = (select.value || '').trim();
            if (!selectedProfile) {
                return;
            }

            var hiddenProfile = document.getElementById('profile-filter');
            if (hiddenProfile) {
                hiddenProfile.value = selectedProfile;
            }

            var renameForm = document.getElementById('profile-rename-form');
            if (renameForm) {
                renameForm.setAttribute('action', '/dashboard/profile/rename?profile=' + encodeURIComponent(selectedProfile));
            }

            if (window.history && window.history.replaceState) {
                var nextURL = '/dashboard?profile=' + encodeURIComponent(selectedProfile);
                window.history.replaceState({}, '', nextURL);
            }

            document.body.dispatchEvent(new Event('trackersChanged'));
        };

        window.renameProfileOnce = function () {
            var select = document.getElementById('profile-switch');
            var hiddenInput = document.getElementById('profile-rename-value');
            var form = document.getElementById('profile-rename-form');
            if (!select || !hiddenInput || !form) {
                return;
            }

            var currentName = select.options && select.selectedIndex >= 0
                ? select.options[select.selectedIndex].text
                : hiddenInput.value;

            var nextName = window.prompt('Rename profile', currentName || '');
            if (nextName === null) {
                return;
            }

            nextName = String(nextName).trim();
            if (!nextName) {
                return;
            }

            hiddenInput.value = nextName;

            var selectedProfile = (select.value || '').trim();
            if (selectedProfile) {
                form.setAttribute('action', '/dashboard/profile/rename?profile=' + encodeURIComponent(selectedProfile));
            }

            form.submit();
        };

        document.addEventListener('DOMContentLoaded', function () {
            var select = document.getElementById('profile-switch');
            if (select) {
                window.onProfileSwitch(select);
            }

            window.updateFilterTagsSummary();
        });

        window.updateFilterTagsSummary = function () {
            var dropdown = document.getElementById('filter-tags-dropdown');
            var summary = document.getElementById('filter-tags-summary');
            if (!dropdown || !summary) {
                return;
            }

            var checks = dropdown.querySelectorAll('input[name="tags"]:checked');
            summary.textContent = String(checks ? checks.length : 0);
        };

        document.addEventListener('change', function (event) {
            var target = event.target;
            if (!target || target.name !== 'tags') {
                return;
            }
            window.updateFilterTagsSummary();
        });

        document.addEventListener('click', function (event) {
            var dropdown = document.getElementById('filter-tags-dropdown');
            if (!dropdown || !dropdown.hasAttribute('open')) {
                return;
            }

            if (dropdown.contains(event.target)) {
                return;
            }

            dropdown.removeAttribute('open');
        });

        window.renderLinkedSources = function (form) {
            if (!form) {
                return;
            }

            var hidden = form.querySelector('#linked-sources-json');
            var list = form.querySelector('#linked-sources-list');
            if (!hidden || !list) {
                return;
            }

            var items = [];
            try {
                items = JSON.parse(hidden.value || '[]');
            } catch (_) {
                items = [];
            }

            if (!Array.isArray(items) || items.length === 0) {
                list.innerHTML = '<p class="search-message">No linked sites yet.</p>';
                return;
            }

            var html = items.map(function (item, index) {
                var sourceName = window.escapeHtml(item.sourceName || ('Source #' + item.sourceId));
                var sourceUrl = window.escapeHtml(item.sourceUrl || '');
                return '' +
                    '<div class="linked-source-row">' +
                    '<span class="linked-source-name">' + sourceName + '</span>' +
                    '<a class="linked-btn" href="' + sourceUrl + '" target="_blank" rel="noopener noreferrer">Open</a>' +
                    '<button type="button" class="linked-btn linked-btn--danger" onclick="window.removeTrackerLinkedSource(' + index + ', this)">Remove</button>' +
                    '</div>';
            }).join('');

            list.innerHTML = html;
        };

        window.syncLinkedSourceSelect = function (form) {
            if (!form) {
                return;
            }

            var select = form.querySelector('#linked-source-id');
            var hidden = form.querySelector('#linked-sources-json');
            var allSourcesHidden = form.querySelector('#all-sources-json');
            if (!select || !hidden || !allSourcesHidden) {
                return;
            }

            var linkedItems = [];
            try {
                linkedItems = JSON.parse(hidden.value || '[]');
            } catch (_) {
                linkedItems = [];
            }
            if (!Array.isArray(linkedItems)) {
                linkedItems = [];
            }

            var allSources = [];
            try {
                allSources = JSON.parse(allSourcesHidden.value || '[]');
            } catch (_) {
                allSources = [];
            }
            if (!Array.isArray(allSources)) {
                allSources = [];
            }

            var linkedSourceIDs = {};
            linkedItems.forEach(function (item) {
                var sourceID = Number(item && item.sourceId);
                if (sourceID > 0) {
                    linkedSourceIDs[sourceID] = true;
                }
            });

            var previousValue = select.value;
            var optionHtml = '<option value="">Select source</option>';
            var hasPreviousValue = false;

            allSources.forEach(function (source) {
                var sourceID = Number(source && source.id);
                if (!sourceID || linkedSourceIDs[sourceID]) {
                    return;
                }

                var value = String(sourceID);
                if (value === previousValue) {
                    hasPreviousValue = true;
                }

                optionHtml += '<option value="' + value + '">' + window.escapeHtml(source.name || ('Source #' + value)) + '</option>';
            });

            select.innerHTML = optionHtml;
            select.value = hasPreviousValue ? previousValue : '';
        };

        window.removeTrackerLinkedSource = function (index, button) {
            var form = button && (button.closest('.tracker-form') || document.querySelector('#modal-zone .tracker-form'));
            if (!form) {
                return;
            }

            var hidden = form.querySelector('#linked-sources-json');
            if (!hidden) {
                return;
            }

            var items = [];
            try {
                items = JSON.parse(hidden.value || '[]');
            } catch (_) {
                items = [];
            }
            if (!Array.isArray(items)) {
                items = [];
            }

            items.splice(index, 1);
            hidden.value = JSON.stringify(items);
            window.renderLinkedSources(form);
            window.syncLinkedSourceSelect(form);
        };

        window.addTrackerLinkedSource = function (button) {
            if (!button) {
                return;
            }

            var form = button.closest('.tracker-form') || document.querySelector('#modal-zone .tracker-form');
            if (!form) {
                return;
            }

            var hidden = form.querySelector('#linked-sources-json');
            if (!hidden) {
                return;
            }

            var sourceId = parseInt(button.dataset.sourceId || '0', 10);
            var sourceUrl = button.dataset.url || '';
            if (!sourceId || !sourceUrl) {
                return;
            }

            var items = [];
            try {
                items = JSON.parse(hidden.value || '[]');
            } catch (_) {
                items = [];
            }
            if (!Array.isArray(items)) {
                items = [];
            }

            var alreadyExists = items.some(function (item) {
                return Number(item.sourceId) === sourceId && String(item.sourceUrl || '').toLowerCase() === sourceUrl.toLowerCase();
            });
            if (alreadyExists) {
                return;
            }

            items.push({
                sourceId: sourceId,
                sourceName: button.dataset.sourceName || '',
                sourceItemId: button.dataset.sourceItemId || '',
                sourceUrl: sourceUrl
            });
            hidden.value = JSON.stringify(items);

            var latestKnownField = form.querySelector('input[name="latest_known_chapter"]');
            var incomingLatestRaw = button.dataset.latestChapter;
            var incomingLatest = parseFloat(String(incomingLatestRaw || '').trim());
            var currentLatest = NaN;
            if (latestKnownField) {
                currentLatest = parseFloat(String(latestKnownField.value || '').trim());
            }

            var shouldPromoteAsPrimary = false;
            if (!Number.isNaN(incomingLatest)) {
                if (Number.isNaN(currentLatest) || incomingLatest > currentLatest) {
                    shouldPromoteAsPrimary = true;
                }
            }

            if (shouldPromoteAsPrimary) {
                var setField = function (selector, value) {
                    if (value === undefined || value === null) {
                        return;
                    }
                    var field = form.querySelector(selector);
                    if (!field) {
                        return;
                    }
                    field.value = value;
                    field.dispatchEvent(new Event('input', { bubbles: true }));
                    field.dispatchEvent(new Event('change', { bubbles: true }));
                };

                setField('select[name="source_id"]', String(sourceId));
                setField('input[name="source_url"]', sourceUrl);
                setField('input[name="source_item_id"]', button.dataset.sourceItemId || '');
                setField('input[name="latest_known_chapter"]', String(incomingLatest));

                var latestReleaseField = form.querySelector('input[name="latest_release_at"]');
                if (latestReleaseField && typeof button.dataset.latestReleaseAt !== 'undefined') {
                    latestReleaseField.value = button.dataset.latestReleaseAt || '';
                }
            }

            window.renderLinkedSources(form);
            window.syncLinkedSourceSelect(form);
        };

        window.applyTrackerSearchResult = function (button) {
            if (!button) {
                return;
            }

            var form = button.closest('.tracker-form') || document.querySelector('#modal-zone .tracker-form');
            if (!form) {
                return;
            }

            var setField = function (selector, value) {
                if (value === undefined || value === null || value === '') {
                    return;
                }
                var field = form.querySelector(selector);
                if (!field) {
                    return;
                }
                field.value = value;
                field.dispatchEvent(new Event('input', { bubbles: true }));
                field.dispatchEvent(new Event('change', { bubbles: true }));
            };

            setField('input[name="title"]', button.dataset.title || '');
            setField('input[name="source_url"]', button.dataset.url || '');
            setField('input[name="source_item_id"]', button.dataset.sourceItemId || '');
            setField('input[name="latest_known_chapter"]', button.dataset.latestChapter || '');

            var latestReleaseField = form.querySelector('input[name="latest_release_at"]');
            if (latestReleaseField) {
                latestReleaseField.value = button.dataset.latestReleaseAt || '';
            }
        };

        window.readTrackerTagsFromForm = function (form) {
            if (!form) {
                return [];
            }
            var rows = Array.prototype.slice.call(form.querySelectorAll('.tracker-tag-row'));
            return rows.map(function (row) {
                var nameInput = row.querySelector('input[name="tracker_tag_name"]');
                var iconInput = row.querySelector('input[name="tracker_tag_icon"]');
                var name = String((nameInput && nameInput.value) || '').trim();
                var iconKey = String((iconInput && iconInput.value) || '').trim();
                if (!name) {
                    return null;
                }
                return {
                    name: name,
                    iconKey: iconKey || null
                };
            }).filter(function (item) { return !!item; });
        };

        window.getTagIconMeta = function (iconKey) {
            var key = String(iconKey || '').trim();
            if (key === 'icon_1') {
                return { key: key, label: 'Star', path: '/assets/tag-icons/icon-star-gold.svg' };
            }
            if (key === 'icon_2') {
                return { key: key, label: 'Heart', path: '/assets/tag-icons/icon-red-heart.svg' };
            }
            if (key === 'icon_3') {
                return { key: key, label: 'Flames', path: '/assets/tag-icons/icon-flames.svg' };
            }
            return { key: key, label: key || 'Icon', path: '' };
        };

        window.selectTrackerTagIcon = function (row, nextIcon) {
            if (!row) {
                return;
            }
            var form = row.closest('.tracker-form') || document.querySelector('#modal-zone .tracker-form');
            if (!form) {
                return;
            }

            var iconInput = row.querySelector('input[name="tracker_tag_icon"]');
            if (!iconInput) {
                return;
            }

            iconInput.value = String(nextIcon || '').trim();
            iconInput.dataset.selected = '';
            window.refreshTrackerTagRows(form);
        };

        window.collectTrackerTagPool = function (form) {
            if (!form) {
                return [];
            }

            var pool = [];
            var seen = {};

            var register = function (name) {
                var cleaned = String(name || '').trim();
                var normalized = cleaned.toLowerCase();
                if (!cleaned || seen[normalized]) {
                    return;
                }
                seen[normalized] = true;
                pool.push(cleaned);
            };

            var profileTagsRaw = form.querySelector('#profile-tags-json');
            if (profileTagsRaw) {
                try {
                    var profileTags = JSON.parse(profileTagsRaw.value || '[]');
                    if (Array.isArray(profileTags)) {
                        profileTags.forEach(function (item) {
                            register(item && item.name);
                        });
                    }
                } catch (_) { }
            }

            window.readTrackerTagsFromForm(form).forEach(function (item) {
                register(item.name);
            });

            return pool;
        };

        window.refreshTrackerTagRows = function (form) {
            if (!form) {
                return;
            }

            var rows = Array.prototype.slice.call(form.querySelectorAll('.tracker-tag-row'));
            var iconKeysRaw = form.querySelector('#tag-icon-keys-json');
            var iconKeys = [];
            try {
                iconKeys = JSON.parse((iconKeysRaw && iconKeysRaw.value) || '[]');
            } catch (_) {
                iconKeys = [];
            }
            if (!Array.isArray(iconKeys)) {
                iconKeys = [];
            }

            var tagPool = window.collectTrackerTagPool(form);

            rows.forEach(function (row) {
                var nameInput = row.querySelector('input[name="tracker_tag_name"]');
                var datalist = row.querySelector('datalist');
                if (datalist) {
                    datalist.innerHTML = tagPool.map(function (name) {
                        return '<option value="' + window.escapeHtml(name) + '"></option>';
                    }).join('');
                }

                if (nameInput && !nameInput.dataset.bound) {
                    nameInput.dataset.bound = '1';
                    nameInput.addEventListener('input', function () {
                        window.refreshTrackerTagRows(form);
                    });
                }
            });

            var usedIcons = {};
            rows.forEach(function (row) {
                var iconInput = row.querySelector('input[name="tracker_tag_icon"]');
                var selected = String((iconInput && (iconInput.value || iconInput.dataset.selected)) || '').trim();
                if (selected) {
                    usedIcons[selected] = true;
                }
            });

            rows.forEach(function (row) {
                var iconInput = row.querySelector('input[name="tracker_tag_icon"]');
                var picker = row.querySelector('.tracker-tag-icon-picker');
                if (!iconInput || !picker) {
                    return;
                }

                var selected = String(iconInput.value || iconInput.dataset.selected || '').trim();
                var html = '<button type="button" class="tracker-tag-icon-btn' + (selected === '' ? ' tracker-tag-icon-btn--active' : '') + '" data-tag-icon="1" data-icon-key="" title="No icon">None</button>';

                iconKeys.forEach(function (iconKey) {
                    var isUsedByAnother = usedIcons[iconKey] && selected !== iconKey;
                    if (isUsedByAnother) {
                        return;
                    }
                    var meta = window.getTagIconMeta(iconKey);
                    var activeClass = selected === iconKey ? ' tracker-tag-icon-btn--active' : '';
                    html += '' +
                        '<button type="button" class="tracker-tag-icon-btn' + activeClass + '" data-tag-icon="1" data-icon-key="' + window.escapeHtml(iconKey) + '" title="' + window.escapeHtml(meta.label) + '">' +
                        '<img src="' + window.escapeHtml(meta.path) + '" alt="' + window.escapeHtml(meta.label) + '">' +
                        '</button>';
                });

                picker.innerHTML = html;
                iconInput.dataset.selected = '';

                var selectedStillAvailable = selected === '' || iconKeys.some(function (key) {
                    return key === selected && (!usedIcons[key] || selected === key);
                });
                if (!selectedStillAvailable) {
                    iconInput.value = '';
                }
            });

            var hidden = form.querySelector('#tracker-tags-json');
            if (hidden) {
                hidden.value = JSON.stringify(window.readTrackerTagsFromForm(form));
            }
        };

        window.addTrackerTagRow = function (button) {
            var form = button && (button.closest('.tracker-form') || document.querySelector('#modal-zone .tracker-form'));
            if (!form) {
                return;
            }

            var list = form.querySelector('#tracker-tags-list');
            if (!list) {
                return;
            }

            var rowId = 'tracker-tag-options-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
            var row = document.createElement('div');
            row.className = 'tracker-tag-row';
            row.innerHTML = '' +
                '<label>' +
                'Tag name' +
                '<input type="text" name="tracker_tag_name" list="' + rowId + '" maxlength="40" placeholder="e.g. Favorite">' +
                '<datalist id="' + rowId + '"></datalist>' +
                '</label>' +
                '<label>' +
                'Icon' +
                '<div class="tracker-tag-icon-picker"></div>' +
                '<input type="hidden" name="tracker_tag_icon" value="">' +
                '</label>' +
                '<button type="button" class="linked-btn linked-btn--danger" onclick="window.removeTrackerTagRow(this)">Remove</button>';
            list.appendChild(row);
            window.refreshTrackerTagRows(form);
        };

        window.removeTrackerTagRow = function (button) {
            var row = button && button.closest('.tracker-tag-row');
            var form = button && (button.closest('.tracker-form') || document.querySelector('#modal-zone .tracker-form'));
            if (row) {
                row.remove();
            }
            if (form) {
                window.refreshTrackerTagRows(form);
            }
        };

        window.renderTrackerTagRows = function (form) {
            if (!form) {
                return;
            }

            var list = form.querySelector('#tracker-tags-list');
            var hidden = form.querySelector('#tracker-tags-json');
            if (!list || !hidden) {
                return;
            }

            var items = [];
            try {
                items = JSON.parse(hidden.value || '[]');
            } catch (_) {
                items = [];
            }
            if (!Array.isArray(items)) {
                items = [];
            }

            if (items.length === 0) {
                items = [{ name: '', iconKey: null }];
            }

            list.innerHTML = items.map(function (item, index) {
                var rowId = 'tracker-tag-options-static-' + index;
                return '' +
                    '<div class="tracker-tag-row">' +
                    '<label>Tag name<input type="text" name="tracker_tag_name" list="' + rowId + '" maxlength="40" placeholder="e.g. Favorite" value="' + window.escapeHtml(item && item.name || '') + '"><datalist id="' + rowId + '"></datalist></label>' +
                    '<label>Icon<div class="tracker-tag-icon-picker"></div><input type="hidden" name="tracker_tag_icon" value="' + window.escapeHtml(item && item.iconKey || '') + '" data-selected="' + window.escapeHtml(item && item.iconKey || '') + '"></label>' +
                    '<button type="button" class="linked-btn linked-btn--danger" onclick="window.removeTrackerTagRow(this)">Remove</button>' +
                    '</div>';
            }).join('');

            window.refreshTrackerTagRows(form);
        };

        document.body.addEventListener('htmx:afterSwap', function (event) {
            if (!event || !event.target || event.target.id !== 'modal-zone') {
                return;
            }
            var form = event.target.querySelector('.tracker-form');
            if (form) {
                window.renderLinkedSources(form);
                window.syncLinkedSourceSelect(form);
                window.renderTrackerTagRows(form);
            }
        });

        document.body.addEventListener('click', function (event) {
            var button = event.target && event.target.closest('[data-tag-icon="1"]');
            if (!button) {
                return;
            }

            var row = button.closest('.tracker-tag-row');
            if (!row) {
                return;
            }

            event.preventDefault();
            window.selectTrackerTagIcon(row, button.dataset.iconKey || '');
        }, true);

        document.body.addEventListener('click', function (event) {
            var button = event.target && event.target.closest('[data-menu-icon]');
            if (!button) {
                return;
            }

            var form = button.closest('form');
            if (!form) {
                return;
            }

            var hidden = form.querySelector('#menu-tag-icon-key');
            var picker = button.closest('.tracker-tag-icon-picker--menu');
            if (!hidden || !picker) {
                return;
            }

            event.preventDefault();
            hidden.value = String(button.dataset.menuIcon || '').trim();

            Array.prototype.forEach.call(picker.querySelectorAll('[data-menu-icon]'), function (candidate) {
                candidate.classList.remove('tracker-tag-icon-btn--active');
            });
            button.classList.add('tracker-tag-icon-btn--active');
        }, true);
    </script>
</body>

</html>
