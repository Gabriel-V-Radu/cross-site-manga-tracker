<div class="modal-backdrop">
    <div class="modal-card profile-menu-card" onclick="event.stopPropagation()">
        <header class="profile-menu-header">
            <h2>Profile Settings</h2>
            <button type="button" class="close-btn" hx-get="/dashboard/trackers/empty-modal" hx-target="#modal-zone">&times;</button>
        </header>

        {{if .Message}}
        <p class="profile-feedback">{{.Message}}</p>
        {{end}}

        <div class="profile-menu-top">
            <section class="profile-pane profile-pane--left">
                <h3>Profile</h3>

                <form class="tracker-form profile-pane-form" method="post" action="/dashboard/profile/switch">
                    <label>
                        Active Profile
                        <div class="profile-inline-controls">
                            <select name="profile">
                                {{range .Profiles}}
                                <option value="{{.Key}}" {{if eq .Key $.ActiveProfile.Key}}selected{{end}}>{{.Name}}</option>
                                {{end}}
                            </select>
                            <button type="submit" class="action-btn action-btn--accent">Switch</button>
                        </div>
                    </label>
                </form>

                <form class="tracker-form profile-pane-form" method="post" action="/dashboard/profile/rename?profile={{.ActiveProfile.Key}}">
                    <label>
                        Rename Profile
                        <input type="text" name="profile_name" value="{{.RenameValue}}" maxlength="40" required>
                    </label>
                    <div class="modal-actions modal-actions--left">
                        <button type="submit" class="action-btn action-btn--accent">Save Changes</button>
                    </div>
                </form>
            </section>

            <section class="profile-pane profile-pane--right">
                <h3>Custom Tags</h3>
                <p class="profile-pane-subtitle">Your tags ({{len .ProfileTags}})</p>

                <div class="tracker-tags-list tracker-tags-list--menu">
                    {{if eq (len .ProfileTags) 0}}
                    <span class="tracker-tag-chip">No tags yet</span>
                    {{else}}
                    {{range .ProfileTags}}
                    <div class="profile-tag-row profile-tag-row--menu">
                        <span class="tracker-tag-chip profile-tag-chip">
                            {{if .IconPath}}
                            <img class="profile-tag-chip__icon" src="{{.IconPath}}" alt="{{.Name}}" title="{{.Name}}">
                            {{end}}
                            {{.Name}}
                        </span>
                        <div class="profile-tag-actions">
                        <form hx-post="/dashboard/profile/tags/rename?profile={{$.ActiveProfile.Key}}"
                              hx-target="#modal-zone"
                              hx-swap="innerHTML"
                              class="profile-tag-rename-form">
                            <input type="hidden" name="tag_id" value="{{.ID}}">
                            <input type="hidden" name="tag_name" value="{{.Name}}">
                            <button type="button"
                                    class="linked-btn"
                                    data-current-tag-name="{{.Name}}"
                                    onclick="window.editProfileTagName(this)">Edit</button>
                        </form>
                        <form hx-post="/dashboard/profile/tags/delete?profile={{$.ActiveProfile.Key}}"
                              hx-target="#modal-zone"
                              hx-swap="innerHTML"
                              hx-confirm="Delete this tag?"
                              class="profile-tag-delete-form">
                            <input type="hidden" name="tag_id" value="{{.ID}}">
                            <button type="submit" class="linked-btn linked-btn--danger">Remove</button>
                        </form>
                        </div>
                    </div>
                    {{end}}
                    {{end}}
                </div>

                <form class="tracker-form profile-tag-create-form"
                      hx-post="/dashboard/profile/tags?profile={{.ActiveProfile.Key}}"
                      hx-target="#modal-zone"
                      hx-swap="innerHTML">
                    <label>
                        New tag name
                        <input type="text" name="tag_name" maxlength="40" placeholder="e.g. Favorite" required>
                    </label>

                    <label>
                        Icon (optional)
                        <div class="tracker-tag-icon-picker tracker-tag-icon-picker--menu">
                            <button type="button" class="tracker-tag-icon-btn tracker-tag-icon-btn--active" data-menu-icon="" title="No icon">None</button>
                            {{range .AvailableIconKeys}}
                            <button type="button" class="tracker-tag-icon-btn" data-menu-icon="{{.}}" title="{{tagIconLabel .}}">
                                <img src="{{tagIconAssetPath .}}" alt="{{tagIconLabel .}}">
                            </button>
                            {{end}}
                        </div>
                        <input type="hidden" name="icon_key" id="menu-tag-icon-key" value="">
                    </label>

                    <div class="modal-actions">
                        <button type="submit" class="action-btn action-btn--accent">Create</button>
                    </div>
                </form>
            </section>
        </div>

        <section class="profile-menu-section profile-menu-section--source-logos">
            <h3>Site Logos</h3>

            {{if eq (len .LinkedSites) 0}}
            <p class="filter-multi-select__empty">No sites available.</p>
            {{else}}
            <div class="profile-source-logo-table">
                {{range .LinkedSites}}
                <div class="profile-source-logo-table__row">
                    {{$logo := index $.SourceLogoURLs .ID}}
                    <span class="profile-source-logo-table__site">{{.Name}}</span>

                    {{if $logo}}
                    <a class="profile-source-logo-preview-thumb"
                       href="{{$logo}}"
                       target="_blank"
                       rel="noopener noreferrer"
                       title="Open current logo">
                        <img src="{{$logo}}" alt="{{.Name}} logo" loading="lazy">
                    </a>
                    {{else}}
                    <span class="profile-source-logo-preview-thumb profile-source-logo-preview-thumb--empty">No logo</span>
                    {{end}}

                    <form class="profile-source-logo-upload-form"
                          method="post"
                          hx-post="/dashboard/profile/source-logos?profile={{$.ActiveProfile.Key}}"
                          hx-target="#modal-zone"
                          hx-swap="innerHTML"
                          hx-encoding="multipart/form-data"
                          enctype="multipart/form-data">
                        <input type="file"
                               id="source-logo-file-{{.ID}}"
                               class="profile-source-logo-file-input"
                               name="source_logo_file_{{.ID}}"
                               accept=".png,.svg,image/png,image/svg+xml"
                               onchange="this.form.requestSubmit()">
                        <label for="source-logo-file-{{.ID}}" class="linked-btn profile-source-logo-action">Upload</label>
                    </form>

                    <form class="profile-source-logo-remove-form"
                          method="post"
                          hx-post="/dashboard/profile/source-logos?profile={{$.ActiveProfile.Key}}"
                          hx-target="#modal-zone"
                          hx-swap="innerHTML">
                        <input type="hidden" name="source_logo_clear_{{.ID}}" value="1">
                        <button type="submit"
                                class="linked-btn linked-btn--danger profile-source-logo-action"
                                {{if not $logo}}disabled{{end}}>Remove</button>
                    </form>
                </div>
                {{end}}
            </div>
            <p class="profile-source-logo-help">Upload/remove applies immediately. PNG/SVG only, up to 1MB.</p>
            {{end}}
        </section>
    </div>
</div>
