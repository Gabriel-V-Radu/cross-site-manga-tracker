<div class="modal-backdrop">
    <div class="modal-card" onclick="event.stopPropagation()">
        <header>
            <h2>{{if eq .Mode "edit"}}Edit Tracker{{else}}New Tracker{{end}}</h2>
            <button type="button" class="close-btn" hx-get="/dashboard/trackers/empty-modal" hx-target="#modal-zone">×</button>
        </header>

        <form class="tracker-form"
              hx-post="{{if eq .Mode "edit"}}/dashboard/trackers/{{.Tracker.ID}}{{else}}/dashboard/trackers{{end}}?view={{if .ViewMode}}{{.ViewMode}}{{else}}grid{{end}}"
              hx-target="#modal-zone"
              hx-swap="innerHTML"
              hx-indicator="#tracker-save-loading"
              hx-on:submit="var view=document.getElementById('view-input'); var viewInput=this.querySelector('input[name=view_mode]'); if(viewInput){ viewInput.value = (view && view.value) ? view.value : 'grid'; }">
            <input type="hidden" name="view_mode" value="{{if .ViewMode}}{{.ViewMode}}{{else}}grid{{end}}">
            <label>
                Title
                <input type="text" name="title" value="{{if .Tracker}}{{.Tracker.Title}}{{end}}" required>
            </label>

            <label>
                Source
                <select name="source_id" required>
                    <option value="">Select source</option>
                    {{range .Sources}}
                    <option value="{{.ID}}" {{if and $.Tracker (eq $.Tracker.SourceID .ID)}}selected{{end}}>{{.Name}}</option>
                    {{end}}
                </select>
            </label>

            <label>
                Search by Title (Auto-fill)
                <input type="text"
                       id="source-search-input"
                       name="q"
                       placeholder="Type title to search selected source"
                       autocomplete="off"
                       hx-get="/dashboard/trackers/search"
                       hx-target="#source-search-results"
                       hx-trigger="keyup changed delay:350ms"
                       hx-sync="this:replace"
                       hx-include="[name='source_id'], #source-search-input"
                       hx-indicator="#source-search-loading">
            </label>
            <p id="source-search-loading" class="search-loading htmx-indicator">Searching…</p>
            <div id="source-search-results" class="source-search-results"></div>

            {{if eq .Mode "edit"}}
            <hr>
            <h3>Linked Sites</h3>
            <p class="search-message">Search another site and add it as the same manga tracker.</p>
            <input type="hidden" name="linked_sources_json" id="linked-sources-json" value='{{toJSON .LinkedSources}}'>
            <input type="hidden" id="all-sources-json" value='{{toJSON .Sources}}'>
            <div id="linked-sources-list" class="search-results-list"></div>

            <label>
                Site to Add
                <select name="linked_source_id" id="linked-source-id">
                    <option value="">Select source</option>
                    {{range .Sources}}
                    <option value="{{.ID}}">{{.Name}}</option>
                    {{end}}
                </select>
            </label>

            <label>
                Search Additional Site
                <input type="text"
                       id="linked-search-input"
                       name="linked_q"
                       placeholder="Type title to search another source"
                       autocomplete="off"
                       hx-get="/dashboard/trackers/search"
                       hx-target="#linked-search-results"
                       hx-trigger="keyup changed delay:350ms"
                       hx-sync="this:replace"
                       hx-vals='{"intent":"link"}'
                       hx-include="#linked-source-id, #linked-search-input"
                       hx-params="not source_id,q"
                       hx-indicator="#linked-search-loading"
                       hx-on:htmx:config-request="event.detail.parameters.source_id = document.getElementById('linked-source-id').value; event.detail.parameters.q = this.value;">
            </label>
            <p id="linked-search-loading" class="search-loading htmx-indicator">Searching…</p>
            <div id="linked-search-results" class="source-search-results"></div>
            {{end}}

            <label>
                Source URL
                <input type="url" name="source_url" value="{{if .Tracker}}{{.Tracker.SourceURL}}{{end}}" required>
            </label>

            <label>
                Source Item ID
                <input type="text" name="source_item_id" value="{{if .Tracker}}{{textInputValue .Tracker.SourceItemID}}{{end}}">
            </label>

            <input type="hidden" name="latest_release_at" value="{{if .Tracker}}{{timeInputValue .Tracker.LatestReleaseAt}}{{end}}">

            <fieldset class="tracker-status-field">
                <legend>Status</legend>
                <div class="tracker-status-segmented" role="radiogroup" aria-label="Tracker status">
                    <label class="tracker-status-option">
                        <input type="radio"
                               name="status"
                               value="reading"
                               required
                               {{if or (not .Tracker) (eq .Tracker.Status "reading")}}checked{{end}}>
                        <span>Reading</span>
                    </label>
                    <label class="tracker-status-option">
                        <input type="radio"
                               name="status"
                               value="completed"
                               {{if and .Tracker (eq .Tracker.Status "completed")}}checked{{end}}>
                        <span>Completed</span>
                    </label>
                    <label class="tracker-status-option">
                        <input type="radio"
                               name="status"
                               value="on_hold"
                               {{if and .Tracker (eq .Tracker.Status "on_hold")}}checked{{end}}>
                        <span>On Hold</span>
                    </label>
                    <label class="tracker-status-option">
                        <input type="radio"
                               name="status"
                               value="dropped"
                               {{if and .Tracker (eq .Tracker.Status "dropped")}}checked{{end}}>
                        <span>Dropped</span>
                    </label>
                    <label class="tracker-status-option">
                        <input type="radio"
                               name="status"
                               value="plan_to_read"
                               {{if and .Tracker (eq .Tracker.Status "plan_to_read")}}checked{{end}}>
                        <span>Plan to read</span>
                    </label>
                </div>
            </fieldset>

            <div class="split-row">
                <label>
                    Last Read
                    <input type="number" step="0.1" name="last_read_chapter" value="{{if .Tracker}}{{chapterInputValue .Tracker.LastReadChapter}}{{end}}">
                </label>
                <label>
                    Latest Known
                    <input type="number" step="0.1" name="latest_known_chapter" value="{{if .Tracker}}{{chapterInputValue .Tracker.LatestKnownChapter}}{{end}}">
                </label>
            </div>

            <hr>
            <h3>Tags</h3>
            <p class="search-message">Select existing tags for this manga.</p>
            <div class="tracker-tags-list">
                {{if eq (len .ProfileTags) 0}}
                <p class="search-message">No tags available. Create tags from the Profile Menu.</p>
                {{else}}
                {{range .ProfileTags}}
                <label class="tracker-tag-check">
                    <input type="checkbox" name="tag_ids" value="{{.ID}}" {{if hasTagID $.TrackerTags .ID}}checked{{end}}>
                    <span class="tracker-tag-chip">
                        {{if .IconPath}}
                        <img class="tracker-tag-chip__icon" src="{{.IconPath}}" alt="{{.Name}}" title="{{.Name}}" loading="lazy">
                        {{end}}
                        {{.Name}}
                    </span>
                </label>
                {{end}}
                {{end}}
            </div>

            <div class="modal-actions">
                <p id="tracker-save-loading" class="search-loading htmx-indicator">Saving…</p>
                <button type="button" class="action-btn" hx-get="/dashboard/trackers/empty-modal" hx-target="#modal-zone">Cancel</button>
                <button type="submit" class="action-btn action-btn--accent">Save</button>
            </div>
        </form>
    </div>
</div>
